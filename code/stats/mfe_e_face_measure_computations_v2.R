# This script will load, and organize the pavlovia data. Then, computes measures of interest.
# For each participant, a single, new, organized csv file that has all the necessary information will be generated.
# Author: Kianoosh Hosseini at NDCLab @FIU (https://Kianoosh.info; https://NDClab.com)
# Last Update: 2024-12-05 (YYYY-MM-DD)
# This version computes hit rates by binning the face delay. This script computes two bins (early vs. late).
# Early is below 500 ms and late is after 500 ms.
### take everyone that met the cutoffs for enough trials when not binning
### and then just bin them and consider if they still have enough in each seperate bin.

library(tidyverse)
library(dplyr)
library(stringr)
library(psycho) # to compute d' measures, etc.

#Working directory should be the Psychopy experiment directory.
proje_wd <- "/Users/kihossei/Library/CloudStorage/GoogleDrive-hosseinikianoosh@gmail.com/My Drive/My Digital Life/Professional/Github_Repos/mfe-e-dataset"
setwd(proje_wd)


input_raw_path <- paste(proje_wd, "sourcedata", "checked", "psychopy", sep ="/", collapse = NULL) # input data directory
input_organized_path <- paste(proje_wd, "derivatives", "psychopy", "csv_output", sep ="/", collapse = NULL) # input directory for data files generated by the organizer script!
output_path <- paste(proje_wd, "derivatives", "psychopy", "stat_output", sep ="/", collapse = NULL) # output directory
proc_fileName <- "processed_data_mfe_e_Proj_v2.csv" # output filename
flanker_csv_fileName <- "_mfe_e_flankerDat_v1.csv" # each output csv file will have this on its filename
surprise_csv_fileName <- "_mfe_e_surpriseDat_v1.csv" # each output csv file will have this on its filename


## creating a list of all raw data csv files in the input folder.
raw_datafiles_list <- c() # an empty list that will be filled in the next "for" loop!
csvSelect <- list.files(input_raw_path, pattern = ".csv") # listing only csv files
for (i in 1:length(csvSelect)){
  temp_for_file <- ifelse (str_detect(csvSelect[i], "mfe_e", negate = FALSE), 1, 0)
  if (temp_for_file == 1){
    temp_list <- csvSelect[i]
    raw_datafiles_list <- c(raw_datafiles_list, temp_list)
  }
}
# Creating the main empty dataframe that will be filled with the data from the loop below:
main_df <- setNames(data.frame(matrix(ncol = 49, nrow = 0)), c("participant_id", "congAcc", "incongAcc",
                                                               "incongruent_dat_meanRT", "errorDat_meanRT", "congruent_dat_meanRT", "corrDat_meanRT",
                                                               "congCorr_meanRT", "incongCorr_meanRT", "congCorr_logMeanRT",
                                                               "congErr_meanRT", "incongErr_meanRT", "congErr_logMeanRT", "incongErr_logMeanRT",
                                                               "incongCorr_logMeanRT", "flankEff_meanACC", "flankEff_meanRT", "flankEff_logMeanRT",
                                                               "reported_errors", "committed_errors", "memoryBias_score", "overall_hitRate", "early_error_hitRate",
                                                               "early_correct_hitRate", "num_early_incong_correctFaces_reported_new", "num_early_incong_correctFaces_reported_old",
                                                               "num_early_incong_errorFaces_reported_new", "num_early_incong_errorFaces_reported_old", "late_error_hitRate",
                                                               "late_correct_hitRate", "num_late_incong_correctFaces_reported_new", "num_late_incong_correctFaces_reported_old",
                                                               "num_late_incong_errorFaces_reported_new", "num_late_incong_errorFaces_reported_old", "hit_num", "false_alrams_num",
                                                               "miss_num", "corr_rej_num", "early_incong_error_hit_num",
                                                               "early_incong_correct_hit_num", "early_incong_error_miss_num",
                                                               "early_incong_correct_miss_num", "early_hitRate_error_minus_correct", "late_incong_error_hit_num",
                                                               "late_incong_correct_hit_num", "late_incong_error_miss_num",
                                                               "late_incong_correct_miss_num", "late_hitRate_error_minus_correct","overall_dPrime"))

# Counters for the number of excluded people based on each criterion
num_of_participants_removed_based_on_memory_surp_trial_removal <- 0 # Will be updated in the loop below
num_of_participants_removed_based_on_accuracy <- 0 # Will be updated in the loop below
num_of_participants_removed_based_on_incong_error_num <- 0 # Will be updated in the loop below
num_participants_removed_based_on_num_incong_error_faces_in_memory_surp <- 0 # Will be updated in the loop below
num_of_participants_removed_based_on_surp_response_frequency_andOR_repeated_ans <- 0

# Looping over all participants
for (subject in 1:length(raw_datafiles_list)){
  #for this participant, find the raw csv file
  psychopy_file <- paste(input_raw_path,raw_datafiles_list[subject], sep = "/", collapse = NULL)

  #read in the data for this participant, establish id, and remove extraneous variables
  psychopyDat <- read.csv(file = psychopy_file, stringsAsFactors = FALSE, na.strings=c("", "NA"))
  participant_id <- psychopyDat$id[1]

  # Load this participant's flanker and surprise data frames
  flanker_name <- paste0(participant_id, flanker_csv_fileName, sep = "", collapse = NULL)
  surprise_name <- paste0(participant_id, surprise_csv_fileName, sep = "", collapse = NULL)
  flanker_df <- read.csv(file = paste(input_organized_path, flanker_name, sep = "/", collapse = NULL), stringsAsFactors = FALSE, na.strings=c("", "NA"))
  surprise_df <- read.csv(file = paste(input_organized_path, surprise_name, sep = "/", collapse = NULL), stringsAsFactors = FALSE, na.strings=c("", "NA"))

  # removing participants based on whether they just pressed the keys without actually paying attention to the task.
  # We check this by "keep_surp_memory_trial_based_on_rt" variables
  # in the surprise_df data frame. O means that they have responded faster than 200 ms during the given trial
  # and therefore, we need to remove that surprise trial.
  # If more than 37.5% of surprise trials are removed, we exclude that participant.
  number_of_removed_trials_in_the_memory_surp <- nrow(surprise_df) - (sum(surprise_df$keep_surp_memory_trial_based_on_rt))
  number_of_faces_in_surp_memory_task <- nrow(surprise_df)
  surp_rt_threshold <- round(0.375 * number_of_faces_in_surp_memory_task)

  if (number_of_removed_trials_in_the_memory_surp <= surp_rt_threshold){ # Participants who have less than surp_rt_threshold surprise
    # trials removed, will be included.

    # Check to see if this participant has the flanker accuracy above 60%
    if (mean(as.numeric(flanker_df$current_trial_accuracy)) >= 0.6){

      # If this participant has at least 3 blocks marked for exclusion (based on response frequency and repeated responses), we exclude them.
      if (surprise_df$num_blocks_excluded[1] <= 3){

        # check to see if the participant has at least 8 legit incongruent errors or not.
      incong_flankerDat <- filter(flanker_df, current_trial_congruency == 0)
      cong_flankerDat <- filter(flanker_df, current_trial_congruency == 1)
      error_incong_flankerDat <- filter(incong_flankerDat, current_trial_accuracy == 0)
      legit_error_incong_flankerDat <- filter(error_incong_flankerDat, current_trial_legitResponse == 1)
      if (nrow(legit_error_incong_flankerDat) >= 8 ){

        # Checking to see if there are at least 8 incongruent error faces in the surprise_df of this participant.
        # First we need to remove the trials that are marked based on rt!
        surprise_df <- filter(surprise_df, keep_surp_memory_trial_based_on_rt == 1)
        num_incong_error_faces_in_surp <- 0
        # Counting the number of legit incong error faces available in surprise_df!
        for (rr in 1:nrow(legit_error_incong_flankerDat)){
          temp_face <- legit_error_incong_flankerDat$current_trial_face[rr]
          temp_for_surp <- filter(surprise_df, face == temp_face)
          errorFace_exist_in_surpDat <- ifelse(nrow(temp_for_surp) == 1, 1,0)
          if (errorFace_exist_in_surpDat == 1){
            num_incong_error_faces_in_surp <- num_incong_error_faces_in_surp + 1
          }
        } # Closing the loop that counts the number of incong error faces available in surprise_df!
        if (num_incong_error_faces_in_surp >= 8){

          incongAcc <- mean(as.numeric(incong_flankerDat$current_trial_accuracy))
          congAcc <- mean(as.numeric(cong_flankerDat$current_trial_accuracy))

          # subset the data for correct and error trials, separately for congruent and incongruent trials, creating new data frames for each
          corrDat <- flanker_df[flanker_df$current_trial_accuracy == 1,]
          corrDat_meanRT <- mean(corrDat$current_trial_rt, na.rm = TRUE)

          congruent_dat <- flanker_df[flanker_df$current_trial_congruency == 1,]
          congruent_dat_meanRT <- mean(congruent_dat$current_trial_rt, na.rm = TRUE)

          cong_corrDat <- corrDat[corrDat$current_trial_congruency == 1,]
          incong_corrDat <- corrDat[corrDat$current_trial_congruency == 0,]

          errorDat <- flanker_df[flanker_df$current_trial_accuracy == 0,]
          errorDat_meanRT <- mean(errorDat$current_trial_rt, na.rm = TRUE)

          incongruent_dat <- flanker_df[flanker_df$current_trial_congruency == 0,]
          incongruent_dat_meanRT <- mean(incongruent_dat$current_trial_rt, na.rm = TRUE)


          cong_errorDat <- errorDat[errorDat$current_trial_congruency == 1,]
          incong_errorDat <- errorDat[errorDat$current_trial_congruency == 0,]
          #for correct trials, compute mean RT (raw and log-corrected)
          congCorr_meanRT <- mean(cong_corrDat$current_trial_rt, na.rm = TRUE)
          incongCorr_meanRT <- mean(incong_corrDat$current_trial_rt, na.rm = TRUE)

          congErr_meanRT <- mean(cong_errorDat$current_trial_rt, na.rm = TRUE)
          incongErr_meanRT <- mean(incong_errorDat$current_trial_rt, na.rm = TRUE)

          congCorr_logMeanRT <- mean(log((1+cong_corrDat$current_trial_rt)), na.rm = TRUE)
          incongCorr_logMeanRT <- mean(log((1+incong_corrDat$current_trial_rt)), na.rm = TRUE)

          congErr_logMeanRT <- mean(log((1+cong_errorDat$current_trial_rt)), na.rm = TRUE)
          incongErr_logMeanRT <- mean(log((1+incong_errorDat$current_trial_rt)), na.rm = TRUE)

          # compute flanker-effect scores for accuracy, RT, log-RT
          flankEff_meanACC <- incongAcc - congAcc
          flankEff_meanRT <- incongCorr_meanRT - congCorr_meanRT
          flankEff_logMeanRT <- incongCorr_logMeanRT - congCorr_logMeanRT

          #
          # number of committed errors in the flanker task
          committed_errors <- nrow(errorDat)
          # number of reported errors
          psychopyDatTrim <- psychopyDat[("errorNum_text_box.text")] # stores the number of reported errors by subjects
          reported_errors <- subset(psychopyDatTrim, complete.cases(psychopyDatTrim$errorNum_text_box.text))
          reported_errors <- reported_errors$errorNum_text_box.text # number of reported errors by participants
          reported_errors <- str_extract_all(reported_errors, '\\d+\\.?\\d*') # to extract all sequences of digits from the input string
          # There was a participant who had reported 70/100. values 70 and 100. To solve this issue, I replace this kind of values with NAs!
          if (length(reported_errors) == 0){ # there is no reported errors
            reported_errors <- NA
            memoryBias_score <- NA
          } else {
            reported_errors <- parse_number(reported_errors[[1]]) # in cases like 70/100, we will have 70 100 at this stage. So, length(reported_errors) will
            # higher than 1.
            if (length(reported_errors) > 1){ # In case they have reported sth like 70/100
              reported_errors <- NA
              memoryBias_score <- NA
            } else if (length(reported_errors) == 1){
              reported_errors <- reported_errors[1]
              memoryBias_score <- ((reported_errors - committed_errors)/ reported_errors) # percent bias score calculation
            }
          }
          ##############################################################################################################
          ############################################## EARLY BIN #####################################################
          ##############################################################################################################
          early_bin_error_incong_flankerDat <- filter(error_incong_flankerDat, current_trial_face_delay_time <= 0.5)
          early_bin_correct_incong_flankerDat <- filter(incong_corrDat, current_trial_face_delay_time <= 0.5)

          ### number of incong error faces identified as old
          num_early_incong_errorFaces_reported_old <- 0 # this is the number of incongruent error faces that they report as OLD and will be updated in the loop below:
          num_early_incong_errorFaces_reported_new <- 0
          for (iii in 1:nrow(early_bin_error_incong_flankerDat)){
            if (early_bin_error_incong_flankerDat$current_trial_legitResponse[iii] == 1){ # if this trial is legit
              temp_face_from_flanker <- early_bin_error_incong_flankerDat$current_trial_face[iii]
              temp_face_row_in_surp <- filter(surprise_df, face == temp_face_from_flanker)
              if (nrow(temp_face_row_in_surp) == 1){ # if old incong error face exist in the surprise_df
                if (temp_face_row_in_surp$surpAcc == 1){ # the old face is chosen as old correctly
                  num_early_incong_errorFaces_reported_old <- num_early_incong_errorFaces_reported_old + 1 # The number of incongruent error faces that they report as OLD
                } else if (temp_face_row_in_surp$surpAcc == 0){ # the new face is chosen as old incorrectly
                  num_early_incong_errorFaces_reported_new <- num_early_incong_errorFaces_reported_new + 1 # The number of incongruent error faces that they report as New
                }
              }
            }
          } # closing the loop over error incong flankerDat


          ### number of incong correct faces identified as old
          num_early_incong_correctFaces_reported_old <- 0 # this is the number of incongruent correct faces that they report as Old and will be updated in the loop below:
          num_early_incong_correctFaces_reported_new <- 0
          for (iii in 1:nrow(early_bin_correct_incong_flankerDat)){
            if (early_bin_correct_incong_flankerDat$current_trial_legitResponse[iii] == 1){ # if this trial is legit
              temp_face_from_flanker <- early_bin_correct_incong_flankerDat$current_trial_face[iii]
              temp_face_row_in_surp <- filter(surprise_df, face == temp_face_from_flanker)
              if (nrow(temp_face_row_in_surp) == 1){ # if old incong correct face exist in the surprise_df
                if (temp_face_row_in_surp$surpAcc == 1){ # the old face is chosen as old correctly
                  num_early_incong_correctFaces_reported_old <- num_early_incong_correctFaces_reported_old + 1 # The number of incongruent correct faces that they report as Old
                } else if (temp_face_row_in_surp$surpAcc == 0){ # the new face is chosen as old incorrectly
                  num_early_incong_correctFaces_reported_new <- num_early_incong_correctFaces_reported_new + 1 # The number of incongruent correct faces that they report as New
                }
              }
            }
          } # closing the loop over correct incong flankerDat


          ##############################################################################################################
          ############################################## LATE BIN #####################################################
          ##############################################################################################################
          late_bin_error_incong_flankerDat <- filter(error_incong_flankerDat, current_trial_face_delay_time > 0.5)
          late_bin_correct_incong_flankerDat <- filter(incong_corrDat, current_trial_face_delay_time > 0.5)

          ### number of incong error faces identified as old
          num_late_incong_errorFaces_reported_old <- 0 # this is the number of incongruent error faces that they report as OLD and will be updated in the loop below:
          num_late_incong_errorFaces_reported_new <- 0
          for (iii in 1:nrow(late_bin_error_incong_flankerDat)){
            if (late_bin_error_incong_flankerDat$current_trial_legitResponse[iii] == 1){ # if this trial is legit
              temp_face_from_flanker <- late_bin_error_incong_flankerDat$current_trial_face[iii]
              temp_face_row_in_surp <- filter(surprise_df, face == temp_face_from_flanker)
              if (nrow(temp_face_row_in_surp) == 1){ # if old incong error face exist in the surprise_df
                if (temp_face_row_in_surp$surpAcc == 1){ # the old face is chosen as old correctly
                  num_late_incong_errorFaces_reported_old <- num_late_incong_errorFaces_reported_old + 1 # The number of incongruent error faces that they report as OLD
                } else if (temp_face_row_in_surp$surpAcc == 0){ # the new face is chosen as old incorrectly
                  num_late_incong_errorFaces_reported_new <- num_late_incong_errorFaces_reported_new + 1 # The number of incongruent error faces that they report as New
                }
              }
            }
          } # closing the loop over error incong flankerDat


          ### number of incong correct faces identified as old
          num_late_incong_correctFaces_reported_old <- 0 # this is the number of incongruent correct faces that they report as Old and will be updated in the loop below:
          num_late_incong_correctFaces_reported_new <- 0
          for (iii in 1:nrow(late_bin_correct_incong_flankerDat)){
            if (late_bin_correct_incong_flankerDat$current_trial_legitResponse[iii] == 1){ # if this trial is legit
              temp_face_from_flanker <- late_bin_correct_incong_flankerDat$current_trial_face[iii]
              temp_face_row_in_surp <- filter(surprise_df, face == temp_face_from_flanker)
              if (nrow(temp_face_row_in_surp) == 1){ # if old incong correct face exist in the surprise_df
                if (temp_face_row_in_surp$surpAcc == 1){ # the old face is chosen as old correctly
                  num_late_incong_correctFaces_reported_old <- num_late_incong_correctFaces_reported_old + 1 # The number of incongruent correct faces that they report as Old
                } else if (temp_face_row_in_surp$surpAcc == 0){ # the new face is chosen as old incorrectly
                  num_late_incong_correctFaces_reported_new <- num_late_incong_correctFaces_reported_new + 1 # The number of incongruent correct faces that they report as New
                }
              }
            }
          } # closing the loop over correct incong flankerDat



          # Overall hits, misses, FAs, and Correct rejections regardless of errors and corrects.
          hit_num <- 0
          miss_num <- 0
          corr_rej_num <- 0
          false_alrams_num <- 0

          for (surpTrial in 1:nrow(surprise_df)){
              if (surprise_df$surpAcc[surpTrial] == 1) { # The old face is identified correctly as old
                hit_num <- hit_num + 1
                corr_rej_num <- corr_rej_num + 1
              } else if (surprise_df$surpAcc[surpTrial] == 0){ # The old face is identified incorrectly as new
                miss_num <- miss_num + 1
                false_alrams_num <- false_alrams_num + 1
              }
          } # Closing the loop over surprise_df trials

          overall_hitRate <- (hit_num) / ((hit_num) + miss_num) # hit rate
          overall_false_alarm_rate <- (false_alrams_num)/ ((false_alrams_num) + (corr_rej_num))
          overall_dPrime <- psycho::dprime(hit_num, false_alrams_num, miss_num, corr_rej_num)
          overall_dPrime <- overall_dPrime$dprime

          if (nrow(early_bin_error_incong_flankerDat) >= 8){
            early_incong_error_hit_num <- num_early_incong_errorFaces_reported_old
            early_incong_error_miss_num <- num_early_incong_errorFaces_reported_new
            early_error_hitRate <- (early_incong_error_hit_num) / ((early_incong_error_hit_num) + early_incong_error_miss_num) # hit rate
          } else if (nrow(early_bin_error_incong_flankerDat) < 8){
            early_incong_error_hit_num <- NA
            early_incong_error_miss_num <- NA
            early_error_hitRate <- NA
          }

          if (nrow(late_bin_error_incong_flankerDat) >= 8){
            late_incong_error_hit_num <- num_late_incong_errorFaces_reported_old
            late_incong_error_miss_num <- num_late_incong_errorFaces_reported_new
            late_error_hitRate <- (late_incong_error_hit_num) / ((late_incong_error_hit_num) + late_incong_error_miss_num) # hit rate
          } else if (nrow(late_bin_error_incong_flankerDat) < 8){
            late_incong_error_hit_num <- NA
            late_incong_error_miss_num <- NA
            late_error_hitRate <- NA
          }


          early_incong_correct_hit_num <- num_early_incong_correctFaces_reported_old
          early_incong_correct_miss_num <- num_early_incong_correctFaces_reported_new
          early_correct_hitRate <- (early_incong_correct_hit_num) / ((early_incong_correct_hit_num) + early_incong_correct_miss_num) # hit rate

          late_incong_correct_hit_num <- num_late_incong_correctFaces_reported_old
          late_incong_correct_miss_num <- num_late_incong_correctFaces_reported_new
          late_correct_hitRate <- (late_incong_correct_hit_num) / ((late_incong_correct_hit_num) + late_incong_correct_miss_num) # hit rate

          if (nrow(early_bin_error_incong_flankerDat) >= 8){
            early_hitRate_error_minus_correct <- early_error_hitRate - early_correct_hitRate
          } else if (nrow(early_bin_error_incong_flankerDat) < 8){
            early_hitRate_error_minus_correct <- NA
          }
          if (nrow(late_bin_error_incong_flankerDat) >= 8){
            late_hitRate_error_minus_correct <- late_error_hitRate - late_correct_hitRate
          } else if (nrow(late_bin_error_incong_flankerDat) < 8){
            late_hitRate_error_minus_correct <- NA
          }


            #### filling the main data frame
            main_df[nrow(main_df) + 1,] <-c(participant_id, congAcc, incongAcc,
                                            incongruent_dat_meanRT, errorDat_meanRT, congruent_dat_meanRT, corrDat_meanRT,
                                            congCorr_meanRT, incongCorr_meanRT, congCorr_logMeanRT,
                                            congErr_meanRT, incongErr_meanRT, congErr_logMeanRT, incongErr_logMeanRT,
                                            incongCorr_logMeanRT, flankEff_meanACC, flankEff_meanRT, flankEff_logMeanRT,
                                            reported_errors, committed_errors, memoryBias_score, overall_hitRate, early_error_hitRate,
                                            early_correct_hitRate, num_early_incong_correctFaces_reported_new, num_early_incong_correctFaces_reported_old,
                                            num_early_incong_errorFaces_reported_new, num_early_incong_errorFaces_reported_old, late_error_hitRate,
                                            late_correct_hitRate, num_late_incong_correctFaces_reported_new, num_late_incong_correctFaces_reported_old,
                                            num_late_incong_errorFaces_reported_new, num_late_incong_errorFaces_reported_old, hit_num, false_alrams_num,
                                            miss_num, corr_rej_num, early_incong_error_hit_num,
                                            early_incong_correct_hit_num, early_incong_error_miss_num,
                                            early_incong_correct_miss_num, early_hitRate_error_minus_correct, late_incong_error_hit_num,
                                            late_incong_correct_hit_num, late_incong_error_miss_num,
                                            late_incong_correct_miss_num, late_hitRate_error_minus_correct,overall_dPrime)


        } else { # If a participant has been excluded because they had less than 8 legit incong error faces in the surprise memory task, we add 1 to the counter below.
          num_participants_removed_based_on_num_incong_error_faces_in_memory_surp <- num_participants_removed_based_on_num_incong_error_faces_in_memory_surp + 1
          ### Printing output
          print(paste("Participant ", participant_id, " was excluded due to not having 8 legit incong error faces in the surprise memory task."))
          #### end of printing output
        }
      } else { # If a participant has been excluded because they had less than 8 legit incong errors, we add 1 to the counter below.
        num_of_participants_removed_based_on_incong_error_num <- num_of_participants_removed_based_on_incong_error_num + 1
        ### Printing output
        print(paste("Participant ", participant_id, " was excluded due to not having 8 legit incong errors in the flanker task."))
        #### end of printing output
      }
    } else { # if a participant has been excluded based on whether they have chosen the most chosen surprise response >= 90% and/or repeatedly choosing the same answer (12 times in a row at least)!
        num_of_participants_removed_based_on_surp_response_frequency_andOR_repeated_ans <- num_of_participants_removed_based_on_surp_response_frequency_andOR_repeated_ans + 1
        ### Printing output
        print(paste("Participant ", participant_id, " was excluded due to response frequency and/or repeated answer criteria."))
        #### end of printing output
      }
    } else { # If a participant has been excluded because they had less than 60% flanker accuracy, we add 1 to the counter below.
      num_of_participants_removed_based_on_accuracy <- num_of_participants_removed_based_on_accuracy + 1
      ### Printing output
      print(paste("Participant ", participant_id, " was excluded due to flanker accuracy below 60%."))
      #### end of printing output
    }
  } else { # If a participant has been excluded because they had more than 37.5% surp trial removed, we add 1 to the counter below.
    num_of_participants_removed_based_on_memory_surp_trial_removal <- num_of_participants_removed_based_on_memory_surp_trial_removal + 1
    ### Printing output
    print(paste("Participant ", participant_id, " was excluded as at least 37.5 % of their surprise trials were removed due to fast RT than 200 ms."))
    #### end of printing output
  }
} # Closing the loop for each participant




### Loading RedCap questionnaire data
redcapDat <- read.csv(file = "/Users/kihossei/Library/CloudStorage/GoogleDrive-hosseinikianoosh@gmail.com/My Drive/My Digital Life/Professional/Github_Repos/mfe-e-dataset/derivatives/preprocessed/redcap/202410v0memoryforerr_SCRD_2024-12-03_2224.csv")

# stai state before and after the flanker task were not properly scored on the HPC due to an error in the naming.
# They will be scored here.
# STAI state before
redcapDat$stai5_scrdS_s1_r1_e1 <- rowSums(redcapDat[ , c("stai5_i1_s1_r1_e1", "stai5_i2_s1_r1_e1", "stai5_i3_s1_r1_e1", "stai5_i4_s1_r1_e1","stai5_i5_s1_r1_e1")])

# STAI state After
redcapDat$stai5_scrdS_s1_r1_e2 <- rowSums(redcapDat[ , c("stai5_i1_s1_r1_e1_v2","stai5_i2_s1_r1_e1_v2", "stai5_i3_s1_r1_e1_v2", "stai5_i4_s1_r1_e1_v2","stai5_i5_s1_r1_e1_v2")])
# STAI state difference (After minus Before)
redcapDat$stai5_scrdS_diff <- (redcapDat$stai5_scrdS_s1_r1_e2 - redcapDat$stai5_scrdS_s1_r1_e1)


# scoring postTask_D questionnaire (sum posttaskd_i1, posttaskd_i3, posttaskd_i4,posttaskd_i5)
redcapDat$postTask_d_s1_r1_e1 <- rowSums(redcapDat[ , c("posttaskd_i1_s1_r1_e1","posttaskd_i3_s1_r1_e1", "posttaskd_i4_s1_r1_e1", "posttaskd_i5_s1_r1_e1")])



# Keeping the columns that we need!
redcapDat <- redcapDat[c("record_id", "demo_c_yob_s1_r1_e1", "scaared_b_scrdSoc_s1_r1_e1", "scaared_b_scrdGA_s1_r1_e1", "scaared_b_scrdTotal_s1_r1_e1",
                         "bfne_b_scrdTotal_s1_r1_e1", "epepq15_scrdTotal_s1_r1_e1", "phq8_scrdTotal_s1_r1_e1",
                         "stai5_scrdS_s1_r1_e1", "stai5_scrdS_s1_r1_e2", "stai5_scrdS_diff", "postTask_d_s1_r1_e1")]


# adding new columns to the "main_df" dataframe from redcapDat
for (rr in 1:nrow(main_df)){
  temp_id <- main_df$participant_id[rr]
  tempDat <- filter(redcapDat, record_id == temp_id)
  if (nrow(tempDat) == 1){
    main_df$scaared_b_scrdSoc_s1_r1_e1[rr] <- tempDat$scaared_b_scrdSoc_s1_r1_e1
    main_df$scaared_b_scrdTotal_s1_r1_e1[rr] <- tempDat$scaared_b_scrdTotal_s1_r1_e1
    main_df$bfne_b_scrdTotal_s1_r1_e1[rr] <- tempDat$bfne_b_scrdTotal_s1_r1_e1
    main_df$epepq15_scrdTotal_s1_r1_e1[rr] <- tempDat$epepq15_scrdTotal_s1_r1_e1
    main_df$phq8_scrdTotal_s1_r1_e1[rr] <- tempDat$phq8_scrdTotal_s1_r1_e1
    main_df$stai5_scrdS_s1_r1_e1[rr] <- tempDat$stai5_scrdS_s1_r1_e1
    main_df$stai5_scrdS_s1_r1_e2[rr] <- tempDat$stai5_scrdS_s1_r1_e2
    main_df$stai5_scrdS_diff[rr] <- tempDat$stai5_scrdS_diff
    main_df$postTask_d_s1_r1_e1[rr] <- tempDat$postTask_d_s1_r1_e1
    main_df$scaared_b_scrdGA_s1_r1_e1[rr] <- tempDat$scaared_b_scrdGA_s1_r1_e1
  } else if (nrow(tempDat) == 0){
    main_df$scaared_b_scrdSoc_s1_r1_e1[rr] <- NA
    main_df$scaared_b_scrdTotal_s1_r1_e1[rr] <- NA
    main_df$bfne_b_scrdTotal_s1_r1_e1[rr] <- NA
    main_df$epepq15_scrdTotal_s1_r1_e1[rr] <- NA
    main_df$phq8_scrdTotal_s1_r1_e1[rr] <- NA
    main_df$stai5_scrdS_s1_r1_e1[rr] <- NA
    main_df$stai5_scrdS_s1_r1_e2[rr] <- NA
    main_df$stai5_scrdS_diff[rr] <- NA
    main_df$postTask_d_s1_r1_e1[rr] <- NA
    main_df$scaared_b_scrdGA_s1_r1_e1[rr] <- NA
  }
}



####################
# Save the dataset
#write the extracted and computed summary scores to disk
write.csv(main_df, paste(output_path, proc_fileName, sep = "/", collapse = NULL), row.names=FALSE)
##################


